<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRXUSDT Orderbook Heatmap</title>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --header-color: #ffc107;
            --btn-color: #2c2c2c;
            --btn-hover: #3c3c3c;
            --chart-grid: #333;
            --chart-border: #555;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            margin-bottom: 20px;
            border-bottom: 1px solid var(--chart-border);
            padding-bottom: 10px;
        }
        
        h1 {
            color: var(--header-color);
            margin: 0;
            font-size: 2rem;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        label {
            font-weight: 500;
        }
        
        select, button {
            background-color: var(--btn-color);
            color: var(--text-color);
            border: 1px solid var(--chart-border);
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        select:hover, button:hover {
            background-color: var(--btn-hover);
        }
        
        button {
            font-weight: 500;
        }
        
        .chart-wrapper {
            position: relative;
            height: 75vh;
            margin-bottom: 20px;
            border: 1px solid var(--chart-border);
            border-radius: 4px;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 4px;
        }
        
        .loading-spinner {
            border: 5px solid #333;
            border-top: 5px solid var(--header-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .chart-container {
            position: relative;
            height: 100%;
            width: 100%;
        }
        
        #priceChart {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #heatmapOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .status {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #999;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 20px;
            height: 10px;
            border-radius: 2px;
        }
        
        .legend-buy {
            background-color: rgba(0, 255, 0, 0.3);
        }
        
        .legend-sell {
            background-color: rgba(255, 0, 0, 0.3);
        }
        
        .legend-liquidity {
            background-color: yellow;
            height: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>TRXUSDT Orderbook Heatmap</h1>
        </header>
        
        <div class="controls">
            <div class="control-group">
                <label for="timeRange">Time Range:</label>
                <select id="timeRange">
                    <option value="3600">Last Hour</option>
                    <option value="7200">Last 2 Hours</option>
                    <option value="14400">Last 4 Hours</option>
                    <option value="43200">Last 12 Hours</option>
                    <option value="86400">Last 24 Hours</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="intervalSelect">Interval:</label>
                <select id="intervalSelect">
                    <option value="60">1 Minute</option>
                    <option value="300">5 Minutes</option>
                    <option value="900">15 Minutes</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="heatmapIntensity">Heatmap Intensity:</label>
                <select id="heatmapIntensity">
                    <option value="0.5">50%</option>
                    <option value="0.7" selected>70%</option>
                    <option value="1">100%</option>
                </select>
            </div>
            
            <button id="refreshBtn">Refresh Data</button>
        </div>
        
        <div class="chart-wrapper">
            <div id="loadingOverlay" class="loading-overlay">
                <div class="loading-spinner"></div>
            </div>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
                <canvas id="heatmapOverlay"></canvas>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color legend-buy"></div>
                <span>Buy Orders</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-sell"></div>
                <span>Sell Orders</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-liquidity"></div>
                <span>Liquidity Levels</span>
            </div>
        </div>
        
        <div class="status" id="statusText">
            Ready - Waiting for data...
        </div>
    </div>

    <script>
    (function() {
        // Chart instances
        let priceChart = null;
        
        // DOM Elements
        const timeRangeSelect = document.getElementById('timeRange');
        const intervalSelect = document.getElementById('intervalSelect');
        const heatmapIntensitySelect = document.getElementById('heatmapIntensity');
        const refreshBtn = document.getElementById('refreshBtn');
        const statusText = document.getElementById('statusText');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const priceChartCanvas = document.getElementById('priceChart');
        const heatmapOverlay = document.getElementById('heatmapOverlay');
        
        // Helper functions
        function formatDate(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString();
        }
        
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }
        
        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }
        
        function updateStatus(message) {
            statusText.textContent = message;
        }
        
        function resizeOverlay() {
            const chartRect = priceChartCanvas.getBoundingClientRect();
            heatmapOverlay.width = chartRect.width;
            heatmapOverlay.height = chartRect.height;
            heatmapOverlay.style.width = `${chartRect.width}px`;
            heatmapOverlay.style.height = `${chartRect.height}px`;
            
            // If we have data, redraw the heatmap when resizing
            if (window.lastHeatmapData) {
                drawHeatmap(window.lastHeatmapData);
            }
        }
        
        // Initialize the candlestick chart
        function initChart() {
            if (priceChart) {
                priceChart.destroy();
            }
            
            const ctx = priceChartCanvas.getContext('2d');
            
            // Register financial chart type if not registered already
            if (!Chart.controllers.candlestick) {
                window.CandlestickController.register();
            }
            
            priceChart = new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: 'TRXUSDT',
                        data: []
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: {
                                    minute: 'HH:mm'
                                }
                            },
                            grid: {
                                color: 'rgba(80, 80, 80, 0.2)',
                                borderColor: 'rgba(80, 80, 80, 0.4)'
                            },
                            ticks: {
                                color: '#aaa'
                            }
                        },
                        y: {
                            position: 'right',
                            grid: {
                                color: 'rgba(80, 80, 80, 0.2)',
                                borderColor: 'rgba(80, 80, 80, 0.4)'
                            },
                            ticks: {
                                color: '#aaa'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return [
                                        `Open: ${point.o}`,
                                        `High: ${point.h}`,
                                        `Low: ${point.l}`,
                                        `Close: ${point.c}`
                                    ];
                                }
                            }
                        },
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Draw the heatmap overlay
        function drawHeatmap(data) {
            // Store the data for resize events
            window.lastHeatmapData = data;
            
            // Make sure overlay is properly sized
            resizeOverlay();
            
            const ctx = heatmapOverlay.getContext('2d');
            ctx.clearRect(0, 0, heatmapOverlay.width, heatmapOverlay.height);
            
            if (!data.timestamps || !data.timestamps.length || !data.priceLevels || !data.priceLevels.length) {
                updateStatus('No heatmap data available for this time range');
                return;
            }
            
            // Get chart scales
            const xScale = priceChart.scales.x;
            const yScale = priceChart.scales.y;
            
            // Set global alpha based on intensity selection
            const intensity = parseFloat(heatmapIntensitySelect.value);
            
            // Find max volume for normalization
            let maxVolume = 0;
            for (const point of data.heatmap) {
                for (const volume of point.volumes) {
                    maxVolume = Math.max(maxVolume, Math.abs(volume));
                }
            }
            
            // Create buy/sell gradients
            const buyGradient = ctx.createLinearGradient(0, 0, 0, heatmapOverlay.height);
            buyGradient.addColorStop(0, 'rgba(0, 255, 0, 0)');
            buyGradient.addColorStop(1, `rgba(0, 255, 0, ${intensity})`);
            
            const sellGradient = ctx.createLinearGradient(0, 0, 0, heatmapOverlay.height);
            sellGradient.addColorStop(0, `rgba(255, 0, 0, ${intensity})`);
            sellGradient.addColorStop(1, 'rgba(255, 0, 0, 0)');
            
            // Draw heatmap for each timestamp
            for (let i = 0; i < data.timestamps.length; i++) {
                const timestamp = data.timestamps[i];
                const volumes = data.heatmap[i].volumes;
                
                // Calculate x position
                const x = xScale.getPixelForValue(timestamp * 1000); // Convert to milliseconds
                const cellWidth = xScale.width / data.timestamps.length;
                
                // Draw volumes at each price level
                for (let j = 0; j < volumes.length; j++) {
                    const volume = volumes[j];
                    if (Math.abs(volume) < maxVolume * 0.02) continue; // Skip very small volumes
                    
                    const priceLevel = data.priceLevels[j];
                    const y = yScale.getPixelForValue(priceLevel);
                    
                    // Different color based on buy/sell side
                    if (volume > 0) {
                        ctx.fillStyle = buyGradient;
                    } else {
                        ctx.fillStyle = sellGradient;
                    }
                    
                    // Calculate height based on volume
                    const heightFactor = Math.min(Math.abs(volume) / maxVolume, 1) * intensity;
                    const cellHeight = Math.max(2, heightFactor * 20); // At least 2px height
                    
                    // Draw rectangle
                    ctx.fillRect(
                        x - cellWidth/2, 
                        y - cellHeight/2, 
                        cellWidth, 
                        cellHeight
                    );
                }
            }
            
            // Draw horizontal liquidity lines (yellow)
            ctx.strokeStyle = 'yellow';
            ctx.lineWidth = 1.5;
            
            // Aggregate volumes across all timestamps for each price level
            const aggregatedVolumes = new Array(data.priceLevels.length).fill(0);
            
            for (const point of data.heatmap) {
                point.volumes.forEach((volume, i) => {
                    aggregatedVolumes[i] += Math.abs(volume);
                });
            }
            
            // Find high volume price levels (top 15%)
            const sortedVolumes = [...aggregatedVolumes].sort((a, b) => b - a);
            const threshold = sortedVolumes[Math.floor(sortedVolumes.length * 0.15)] || 0;
            
            // Draw horizontal lines at significant liquidity levels
            for (let i = 0; i < aggregatedVolumes.length; i++) {
                if (aggregatedVolumes[i] >= threshold) {
                    const priceLevel = data.priceLevels[i];
                    const y = yScale.getPixelForValue(priceLevel);
                    
                    ctx.beginPath();
                    ctx.moveTo(xScale.left, y);
                    ctx.lineTo(xScale.right, y);
                    ctx.stroke();
                }
            }
            
            updateStatus(`Heatmap updated - Showing data from ${formatDate(data.timestamps[0])} to ${formatDate(data.timestamps[data.timestamps.length-1])}`);
        }
        
        // Fetch and update data
        async function updateData() {
            showLoading();
            updateStatus('Fetching data...');
            
            const timeRange = parseInt(timeRangeSelect.value);
            const interval = parseInt(intervalSelect.value);
            const endTime = Math.floor(Date.now() / 1000);
            const startTime = endTime - timeRange;
            
            try {
                // Fetch candlestick data
                const candleResponse = await fetch(`https://heatmapeldritch.gleeze.com:3500/api/candlesticks?startTime=${startTime}&endTime=${endTime}&interval=${interval}`);
                if (!candleResponse.ok) {
                    throw new Error(`HTTP error: ${candleResponse.status}`);
                }
                const candleData = await candleResponse.json();
                
                if (!candleData || candleData.length === 0) {
                    updateStatus('No candlestick data available for this time range');
                    hideLoading();
                    return;
                }
                
                // Format candlestick data
                const formattedCandles = candleData.map(candle => ({
                    x: new Date(candle.timestamp), // timestamp is in milliseconds
                    o: candle.open,
                    h: candle.high,
                    l: candle.low,
                    c: candle.close
                }));
                
                // Update candlestick chart
                priceChart.data.datasets[0].data = formattedCandles;
                priceChart.update();
                
                // Fetch heatmap data
                const heatmapResponse = await fetch(`https://heatmapeldritch.gleeze.com:3500/api/heatmap?startTime=${startTime}&endTime=${endTime}&buckets=200`);
                if (!heatmapResponse.ok) {
                    throw new Error(`HTTP error: ${heatmapResponse.status}`);
                }
                const heatmapData = await heatmapResponse.json();
                
                // Draw the heatmap
                drawHeatmap(heatmapData);
                
                updateStatus(`Data updated successfully - ${formattedCandles.length} candles loaded`);
            } catch (error) {
                console.error('Error fetching data:', error);
                updateStatus(`Error: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        // Event listeners
        refreshBtn.addEventListener('click', updateData);
        timeRangeSelect.addEventListener('change', updateData);
        intervalSelect.addEventListener('change', updateData);
        heatmapIntensitySelect.addEventListener('change', () => {
            if (window.lastHeatmapData) {
                drawHeatmap(window.lastHeatmapData);
            }
        });
        
        window.addEventListener('resize', resizeOverlay);
        
        // Initialize
        function init() {
            initChart();
            updateData();
        }
        
        // Start app
        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html> 
