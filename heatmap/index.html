<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Book Heatmap</title>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js@2.27.1/dist/plotly.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-container {
            width: 100%;
            height: 800px;
            background-color: #000;
            border-radius: 5px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Order Book Heatmap</h1>
        <div id="chart" class="chart-container"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetchDataAndRender();
        });
        
        async function fetchDataAndRender() {
            try {
                // Get current time range (last hour)
                const end = Date.now();
                const start = end - (60 * 60 * 1000);
                
                // Fetch heatmap data for TRXUSDT with default bucket size
                const heatmapResponse = await fetch(`https://eldritch.gleeze.com:3500/api/orderbook/heatmap?start=${start}&end=${end}`);
                const heatmapData = await heatmapResponse.json();
                
                // Fetch tick data
                const ticksResponse = await fetch(`https://eldritch.gleeze.com:3500/api/orderbook/ticks?start=${start}&end=${end}`);
                const ticksData = await ticksResponse.json();
                
                console.log("Heatmap data:", heatmapData);
                console.log("Ticks data:", ticksData);
                
                renderChart(heatmapData, ticksData);
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('chart').innerHTML = 
                    '<div style="color:white;text-align:center;padding-top:300px;">Error loading data</div>';
            }
        }
        
        function renderChart(heatmapData, ticksData) {
            if (!heatmapData || !heatmapData.times || !heatmapData.buckets || 
                !heatmapData.bidHeat || !heatmapData.askHeat) {
                document.getElementById('chart').innerHTML = 
                    '<div style="color:white;text-align:center;padding-top:300px;">No heatmap data available</div>';
                return;
            }
            
            // Process timestamps
            const times = heatmapData.times.map(t => new Date(t));
            
            // Create bid heatmap
            const bidHeatmap = {
                z: heatmapData.bidHeat,
                x: times,
                y: heatmapData.buckets,
                type: 'heatmap',
                colorscale: [
                    [0, 'rgba(0,0,50,0)'],
                    [0.2, 'rgba(0,0,100,0.2)'],
                    [0.5, 'rgba(0,70,200,0.5)'],
                    [0.8, 'rgba(0,120,255,0.8)'],
                    [1, 'rgba(100,200,255,1)']
                ],
                showscale: false,
                hoverinfo: 'none',
                name: 'Bids'
            };
            
            // Create ask heatmap
            const askHeatmap = {
                z: heatmapData.askHeat,
                x: times,
                y: heatmapData.buckets,
                type: 'heatmap',
                colorscale: [
                    [0, 'rgba(50,0,0,0)'],
                    [0.2, 'rgba(100,50,0,0.2)'],
                    [0.5, 'rgba(200,100,0,0.5)'],
                    [0.8, 'rgba(255,150,0,0.8)'],
                    [1, 'rgba(255,200,50,1)']
                ],
                showscale: false,
                hoverinfo: 'none',
                name: 'Asks'
            };
            
            // Create price trace if tick data is available
            let priceTrace = null;
            if (Array.isArray(ticksData) && ticksData.length > 0) {
                priceTrace = {
                    x: ticksData.map(tick => new Date(tick.timestamp)),
                    y: ticksData.map(tick => tick.price),
                    type: 'scatter',
                    mode: 'lines',
                    line: {
                        color: 'white',
                        width: 2
                    },
                    name: 'Price'
                };
            }
            
            // Combine traces
            const traces = [bidHeatmap, askHeatmap];
            if (priceTrace) traces.push(priceTrace);
            
            // Set layout
            const layout = {
                title: 'TRXUSDT Order Book Heatmap',
                paper_bgcolor: 'black',
                plot_bgcolor: 'black',
                font: {
                    color: 'white'
                },
                xaxis: {
                    title: 'Time',
                    type: 'date',
                    showgrid: true,
                    gridcolor: 'rgba(80, 80, 80, 0.3)',
                    gridwidth: 1,
                    zeroline: false
                },
                yaxis: {
                    title: 'Price',
                    showgrid: true,
                    gridcolor: 'rgba(80, 80, 80, 0.3)',
                    gridwidth: 1,
                    zeroline: false
                },
                margin: {
                    l: 50,
                    r: 50,
                    t: 50,
                    b: 50
                }
            };
            
            // Render the chart
            Plotly.newPlot('chart', traces, layout);
        }
    </script>
</body>
</html>
